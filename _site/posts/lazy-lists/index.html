<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta charset="utf-8">
  <title>
    
      Lazy Lists and Android &ndash;
    
    gregg hernandez
  </title>

  <meta name="author" content="gregg hernandez" />
  <meta name="description" content="A blog about programming and things" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link rel="stylesheet" href="/css/fontawesome.min.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
  <link media="only screen and (max-device-width: 480px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript" src="/js/application.js"></script>
</head>

<body>
  <section class="sidebar">
    <a href="/">
      <img src="https://secure.gravatar.com/avatar/41a6b438156185e1c71cc419dc2f714c.png?s=150" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="fname">gregg</span>
        <span id="lname">hernandez</span>
      </a>
    </section>

    <section class="meta">
      <a href="https://github.com/gregghz" target="_blank"><i class="icon icon-github"></i></a>
      <a href="https://twitter.com/gregghz" target="_blank"><i class="icon icon-twitter"></i></a>
      <a href="/atom.xml"><i class="icon icon-rss"></i></a>
    </section>

    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
  </section>

  <section class="content">
  <h1>
    <a href="/posts/lazy-lists">Lazy Lists and Android</a>
  </h1>

  <section class="byline">
    November 27, 2013
  </section>

  <p>Chet Haase has an article over at <a href='http://graphics-geek.blogspot.com/'>CodeDependent</a> called <a href='http://graphics-geek.blogspot.com/2013/09/lazy-lists.html'>Lazy Lists</a>. I think the main point of the article is to illustrate a simple technique to avoid unnecessary memory allocation in a constrained environment like Android. He gives a solution (in Java, naturally) showing how to lazily instantiate a couple of lists only once the lists are actually needed. It&#8217;s simple enough. If the list we&#8217;re adding to is null, instantiate it and add the item, otherwise, just add the item.</p>

<p>There are two oddities in his implementation I&#8217;d like to point out, and then mostly ignore. He checks for uniqueness when adding an item to a list. Chet does mention this as peculiar to his situation but doesn&#8217;t elaborate. In generel this makes a List seem like an odd choice of data structures. A Set would probably be a much better choice (I&#8217;ll give an example later). He is also nulling out the list once it reaches a length of zero. I can only guess that this is an attempt to get the list GC&#8217;d more quickly once it&#8217;s no longer needed. However, I think in general, it&#8217;s not a good idea to assume that a list of length zero means the same thing as a list we don&#8217;t need anymore so I&#8217;m going to ignore this bit, but I do concede that in specific cases this could be a fair assumption.</p>

<p>Overall, I think Chet&#8217;s general idea is a good one. It&#8217;s a very simple instance of lazy evaluation. You don&#8217;t allocate a new list until you know you need that list. This saves a bit of memory and a few CPU cycles. He basically abstracts out the details of this lazy instantiation into two static methods so that the consumer of one of these lazy lists doesn&#8217;t ever have to worry about the details of how it works.</p>

<p>More than anything, I think this pattern does more to highlight the weaknesses of Java than anything else. A (very) little scala will do the job for us just fine.</p>

<p>If we ignore the oddities I mentioned above (nulling out the empty list by instead opting to reuse the already allocated list, and checking for uniqueness when inserting into the list) the equivilent scala code would look like this (I&#8217;m going to stick to using Java&#8217;s data structures for now, that&#8217;s a Java List, not a Scala List):</p>
<div class='highlight'><pre><code class='scala'><span class='k'>class</span> <span class='nc'>LazyLists</span> <span class='o'>{</span>
    <span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>intList</span><span class='k'>:</span> <span class='kt'>List</span><span class='o'>[</span><span class='kt'>Int</span><span class='o'>]</span> <span class='k'>=</span> <span class='k'>new</span> <span class='nc'>ArrayList</span><span class='o'>[</span><span class='kt'>Int</span><span class='o'>]()</span>
    <span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>floatList</span><span class='k'>:</span> <span class='kt'>List</span><span class='o'>[</span><span class='kt'>Double</span><span class='o'>]</span> <span class='k'>=</span> <span class='k'>new</span> <span class='nc'>ArrayList</span><span class='o'>[</span><span class='kt'>Double</span><span class='o'>]()</span>
        
    <span class='k'>def</span> <span class='n'>addItemBest</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Int</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>intList</span><span class='o'>.</span><span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
    <span class='k'>def</span> <span class='n'>addItemBest</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Double</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>floatList</span><span class='o'>.</span><span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
    <span class='k'>def</span> <span class='n'>removeItemBest</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Int</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>intList</span><span class='o'>.</span><span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='o'>.</span><span class='n'>asInstanceOf</span><span class='o'>[</span><span class='kt'>Object</span><span class='o'>])</span>
    <span class='k'>def</span> <span class='n'>removeItemBest</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Double</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>floatList</span><span class='o'>.</span><span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
<span class='o'>}</span>
</code></pre></div>
<p>That&#8217;s it. We don&#8217;t need a helper class (Chet&#8217;s LazyListManager). And we still don&#8217;t have to think about when/where we are initializing these lists. Scala&#8217;s lazy keyword takes care of all the boilerplate Java makes you work so hard to hide.</p>

<p>You can compare the Scala and Java implementations in a <a href='https://gist.github.com/gregghz/7677880'>gist</a> I created.</p>

<p>I think the biggest advantage here is that the lazy keyword can be applied to any data. The original example would only work on Lists. You would need a new helper class for each type of data you wanted to lazily instantiate (or at least a sufficiently general helper).</p>

<p>In Chet&#8217;s post, he required each element to be unique. How can we accomplish that? We could create a helper class, as Chet did, and send all add and remove requests through that helper. But again, we&#8217;d end up needing a helper for each type we want to lazily instantiate. As I mentioned above, we can just use Sets (specifically a <a href='http://www.scala-lang.org/api/current/index.html#scala.collection.mutable.LinkedHashSet'>mutable.LinkedHashSet</a> so we can maintain traversal order and the mutation semantics in the original example):</p>
<div class='highlight'><pre><code class='scala'><span class='k'>class</span> <span class='nc'>LazySets</span> <span class='o'>{</span>
    <span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>intSet</span><span class='k'>:</span> <span class='kt'>Set</span><span class='o'>[</span><span class='kt'>Int</span><span class='o'>]</span> <span class='k'>=</span> <span class='nc'>LinkedHashSet</span><span class='o'>[</span><span class='kt'>Int</span><span class='o'>]()</span>
    <span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>floatSet</span><span class='k'>:</span> <span class='kt'>Set</span><span class='o'>[</span><span class='kt'>Double</span><span class='o'>]</span> <span class='k'>=</span> <span class='nc'>LinkedHashSet</span><span class='o'>[</span><span class='kt'>Double</span><span class='o'>]()</span>

    <span class='k'>def</span> <span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Int</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>intSet</span><span class='o'>.</span><span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
    <span class='k'>def</span> <span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Double</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>floatSet</span><span class='o'>.</span><span class='n'>add</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
    <span class='k'>def</span> <span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Int</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>intSet</span><span class='o'>.</span><span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
    <span class='k'>def</span> <span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='k'>:</span> <span class='kt'>Double</span><span class='o'>)</span><span class='k'>:</span> <span class='kt'>Unit</span> <span class='o'>=</span> <span class='n'>floatSet</span><span class='o'>.</span><span class='n'>remove</span><span class='o'>(</span><span class='n'>item</span><span class='o'>)</span>
<span class='o'>}</span>
</code></pre></div>
<p>Chet could have used a <a href='https://developer.android.com/reference/java/util/LinkedHashSet.html'>java.util.LinkedHashSet</a> in his example as well. I&#8217;m not sure why he didn&#8217;t. He only mentions his desire for unique elements and then continues to use a List. My point in showing the code above is only to illustrate that lazy is no respecter of persons. It will work with any data structure. It will work with any expression, in fact.</p>
<div class='highlight'><pre><code class='scala'><span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>a</span> <span class='k'>=</span> <span class='mi'>12</span> <span class='o'>+</span> <span class='mi'>15</span>
<span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>b</span> <span class='k'>=</span> <span class='n'>someComplexFunction</span><span class='o'>()</span>
<span class='k'>lazy</span> <span class='k'>val</span> <span class='n'>c</span> <span class='k'>=</span> <span class='k'>if</span> <span class='o'>(</span><span class='n'>a</span> <span class='o'>*</span> <span class='mi'>100</span> <span class='o'>-</span> <span class='mi'>15</span> <span class='o'>&gt;</span> <span class='mi'>99</span><span class='o'>)</span> <span class='nc'>True</span> <span class='k'>else</span> <span class='nc'>False</span>
</code></pre></div>
<p>Each of these will only evaluate the value on the right hand side when the variable is accessed for the first time. It&#8217;s as though they were all written like this:</p>
<div class='highlight'><pre><code class='scala'><span class='k'>val</span> <span class='n'>athunk</span> <span class='k'>=</span> <span class='o'>()</span> <span class='k'>=&gt;</span> <span class='mi'>12</span> <span class='o'>+</span> <span class='mi'>15</span>
<span class='k'>var</span> <span class='nc'>_a</span><span class='k'>:</span> <span class='kt'>Option</span><span class='o'>[</span><span class='kt'>Int</span><span class='o'>]</span> <span class='k'>=</span> <span class='nc'>None</span>
<span class='k'>val</span> <span class='n'>a</span> <span class='k'>=</span> <span class='o'>()</span> <span class='k'>=&gt;</span> <span class='k'>match</span> <span class='nc'>_a</span> <span class='o'>{</span>
    <span class='k'>case</span> <span class='nc'>Some</span><span class='o'>(</span><span class='n'>a</span><span class='o'>)</span> <span class='k'>=&gt;</span> <span class='n'>a</span>
    <span class='k'>case</span> <span class='nc'>None</span> <span class='k'>=&gt;</span> <span class='o'>{</span> <span class='nc'>_a</span> <span class='k'>=</span> <span class='nc'>Some</span><span class='o'>(</span><span class='n'>athunk</span><span class='o'>());</span> <span class='nc'>_a</span> <span class='o'>}</span>
<span class='o'>}</span>
</code></pre></div>
<p>Just using the lazy keyword is much simpler.</p>

<p>Now you might be saying something like, &#8220;this is all great, but Android uses Java, not Scala, so it&#8217;s really useless for my Android projects.&#8221; Fortunately, Scala compiles to Java bytecode. The Android build system turns bytecode into .dex files for Dalvik. That means it&#8217;s not too difficult to use Scala on Android. To help you out (and because you really should stop using Java) I found a sample Android project that utilizes Scala.</p>

<p><a href='https://github.com/jayway/maven-android-plugin-samples/tree/master/scala'>jayway/maven-android-plugin-samples</a></p>

<p>In a later post I plan to talk about real lazy lists. That is, lists whose elements are evaluated lazily. Look out for that. I think it&#8217;s a much more interesting topic than the lazy keyword itself.</p>

  <!-- TODO: bio here -->
  <section class="meta">
    <h3>Discussion, links, and tweets</h3>
    <section class="copy">
      <a href="https://twitter.com/gregghz" target="_blank">
        <img src="https://secure.gravatar.com/avatar/41a6b438156185e1c71cc419dc2f714c.png?s=142" height="50" width="50" />
      </a>

      <p>
        I am learning to be programmer and math.
      </p>

      <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" data-via="gregghz">Tweet</a>
      <a href="http://twitter.com/gregghz" class="twitter-follow-button" data-show-count="false">Follow @gregghz</a>
      <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    </section>
  </section>

  
  <section class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'gregghz'; // required: replace example with your forum shortname
      var disqus_title = 'Lazy Lists and Android';
      var disqus_identifier = 'Lazy Lists and Android';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
  
</section>

</body>

</html>
